# models-as-data extension for the custom mydb library.
#
# These models teach CodeQL about three custom functions so it can
# trace the taint flow:
#
#   myapp_read_input  ──→  myapp_format  ──→  mydb_exec
#        (source)           (summary)          (sink)
#
# Without these models CodeQL sees no SQL injection because it does
# not recognise any of these wrappers.
#
# Reference:
#   https://codeql.github.com/docs/codeql-language-guides/customizing-library-models-for-cpp/

extensions:

  # ── SOURCE ──────────────────────────────────────────────────────────
  #
  # int myapp_read_input(const char *prompt, char *buf, int bufsize);
  #                                          ^^^^^^^^
  # After the call, the buffer pointed to by the second argument (buf)
  # contains untrusted user input from stdin.
  #
  #   Argument[*1]  =  the pointed-to value of the 2nd argument
  #   kind: remote  =  treat this as a remote / untrusted source
  #
  - addsTo:
      pack: codeql/cpp-all
      extensible: sourceModel
    data:
      - ["", "", False, "myapp_read_input", "", "", "Argument[*1]", "remote", "manual"]

  # ── SUMMARY ─────────────────────────────────────────────────────────
  #
  # int myapp_format(char *dst, int dstsize, const char *fmt, const char *value);
  #                  ^^^^^^^^                                 ^^^^^^^^^^^^^^
  # Taint flows from the string content of `value` (4th arg) into the
  # buffer pointed to by `dst` (1st arg).
  #
  #   input:  Argument[*3]  =  pointed-to value of the 4th argument (value)
  #   output: Argument[*0]  =  pointed-to value of the 1st argument (dst)
  #   kind:   taint         =  taint is propagated (not necessarily preserved)
  #
  - addsTo:
      pack: codeql/cpp-all
      extensible: summaryModel
    data:
      - ["", "", False, "myapp_format", "", "", "Argument[*3]", "Argument[*0]", "taint", "manual"]

  # ── SINK ────────────────────────────────────────────────────────────
  #
  # int mydb_exec(mydb_conn *conn, const char *sql);
  #                                ^^^^^^^^^^^^^^^
  # The string content of `sql` (2nd arg) is executed as a SQL query.
  #
  #   input: Argument[*1]  =  pointed-to value of the 2nd argument (sql)
  #   kind:  sql-injection =  matches the standard CodeQL sql-injection query
  #
  - addsTo:
      pack: codeql/cpp-all
      extensible: sinkModel
    data:
      - ["", "", False, "mydb_exec", "", "", "Argument[*1]", "sql-injection", "manual"]
